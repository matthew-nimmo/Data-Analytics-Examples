---
format: html-eval-false
---

# Spatial continuity

Spatial continuity of grades cadmium, cobalt, chrome, copper, nickel, lead and zinc were assessed using geostatistics. The backscatter data and the manganese nodule sample data was used for calculating spatial variograms.

All samples within the Jura deposit boundary were used for analysis of spatial continuity. The PPMT transformed data was used for calculating the experimental variograms.

The direction of greatest continuity suggested by the variogram maps (Figure \@ref(fig:var-map)) is approximately 040&deg; or 140&deg;. This direction is an artefact of the sparseness of the sampling and the orientation of the sampling grid which is oriented 075 degrees, roughly parallel to the broad regional trend of the CCZ.

```{r}
dir_la <- c(140, 40, 140, 40, 40, 40, 140)
names(dir_la) <- flds_est
dir_sa <- ifelse(dir_la < 90, dir_la + 90, dir_la - 90)
```

```{r var-map, fig.width=9, fig.height=9, fig.cap="Variogram maps."}
my_col <- rev(viridis(3))
x <- C__AH$Y
#x <- B__AH
pp <- lapply(flds_est, function(i) {
  k <- complete.cases(x[, c("X","Y",i)])
  y <- x[k, c("X","Y",i)]

  g <- gstat(id=i, formula=formula(paste(i, "~ 1")),
             locations=~X+Y, data=y)
  vgm.map <- variogram(g, width=0.75, cutoff=6, map=TRUE,
                       cressie=FALSE, PR=FALSE, alpha=0, beta=0)

  x <- as.data.frame(vgm.map$map)
  p <- ggplot() +
    geom_raster(data=x, aes(x=dx, y=dy, fill=x[, i])) +
    xlab("dx (km)") + ylab("dy (km)") +
    ggtitle(i, subtitle=sprintf("Major axis = %03d", dir_la[i])) +
    scale_fill_gradientn(name=expression(gamma),
                         colours=my_col, na.value=my_col[3]) +
    theme_tufte() +
    theme(axis.text.x=element_text(size=7),
          axis.text.y=element_text(size=7)) +
    geom_abline(intercept=0, slope=tan((90-dir_la[i])*pi/180),
                linetype="dashed", color="white", size=0.5) +
    guides(fill=guide_colourbar(barwidth=0.8, barheight=5)) +
    coord_fixed()

  return(p)
})

plot_grid(plotlist=pp, ncol=3)
rm(pp, val, valt, my_col, x)
```

Spherical semi-variogram models were fitted to the experimental variograms using two structures for abundance, nickel, copper, and manganese while cobalt was fitted with only one structure. The experimental variograms for cobalt suggest very long ranges in the 075 degrees direction.

The variogram models used for estimating block nodule abundance, nickel, copper, manganese and cobalt are listed in Table \@ref(tab:fit-var) and illustrated in Figure \@ref(fig:exp-var).

```{r fit_var}
C__VAR <- data.frame(
  cd_ppm = c(0.1, 0.6, 0.5, 0.5, 0.5, 0.3, 1.5, 1.5, 1.5, dir_la[1]),
  co_ppm = c(0.1, 0.6, 0.5, 0.5, 0.5, 0.3, 1.5, 1.5, 1.5, dir_la[2]),
  cr_ppm = c(0.1, 0.6, 0.5, 0.5, 0.5, 0.3, 1.5, 1.5, 1.5, dir_la[3]),
  cu_pct = c(0.1, 0.6, 0.5, 0.5, 0.5, 0.3, 1.5, 1.5, 1.5, dir_la[4]),
  ni_ppm = c(0.1, 0.6, 0.5, 0.5, 0.5, 0.3, 1.5, 1.5, 1.5, dir_la[5]),
  pb_ppm = c(0.1, 0.6, 0.5, 0.5, 0.5, 0.3, 1.5, 1.5, 1.5, dir_la[6]),
  zn_ppm = c(0.1, 0.6, 0.5, 0.5, 0.5, 0.3, 1.5, 1.5, 1.5, dir_la[7])
)
row.names(C__VAR) <- c("Nugget",
                       "Sill 1", "Range 1 Omni", "Range 1 Major", "Range 1 Minor",
                       "Sill 2", "Range 2 Omni", "Range 2 Major", "Range 2 Minor",
                       "Major Dir.")
C__VAR <- rbind(C__VAR, Anisotropy=round(sapply(C__VAR, function(x) x[9] / x[8]), 2))

kable(C__VAR)
```

<br>

```{r}
M__VGM <- cache_data("./data/M/M__variograms.rds", function() {
  m <- lapply(flds_est, function(i) {
    x <- C__AH$Y[, c("X","Y",i)]
    j <- complete.cases(x) & !duplicated(x)
    x <- x[j, ]

    # Omni-directional variogram.
    vgm0 <- list(
      vgm = variogram(formula(paste(i, "~ 1")), ~X+Y, data=x, width=0.25),
      fit = vgm(C__VAR[6, i], "Sph", C__VAR[7, i], 0,
                add.to=vgm(C__VAR[2, i], "Sph", C__VAR[3, i], C__VAR[1, i]))
    )

    # Major variogram.
    vgm1 <- list(
      vgm = variogram(formula(paste(i, "~ 1")), ~X+Y, data=x,
                      width=0.25, alpha=dir_la[i], tol.hor=15),
      fit = vgm(C__VAR[6, i], "Sph", C__VAR[8, i], 0,
                add.to=vgm(C__VAR[2, i], "Sph", C__VAR[4, i], C__VAR[1, i]))
    )

    # Minor variogram.
    vgm2 <- list(
      vgm = variogram(formula(paste(i, "~ 1")), ~X+Y, data=x,
                      width=0.25, alpha=dir_sa[i], tol.hor=15),
      fit = vgm(C__VAR[6, i], "Sph", C__VAR[9, i], 0,
                add.to=vgm(C__VAR[2, i], "Sph", C__VAR[5, i], C__VAR[1, i]))
    )

    return(list(omni=vgm0, major=vgm1, minor=vgm2))
  })

  names(m) <- flds_est

  return(m)
})
```

```{r}
plot_var <- function(i, j, cutoff=c(6,6,6)) {
  m <- M__VGM[[i]]

  o <- par(mar=c(5.1,4.1,2.1,1.1), mfcol=c(1, 3), cex=0.8, oma=c(0,0,3,0))

  plot(m$omni$vgm$dist, m$omni$vgm$gamma, type="b", lty="dashed",
       pch=19, cex=0.7, xlim=c(0, cutoff[1]), ylim=c(0, 1.3),
       main="", frame.plot=FALSE, xlab="Distance (km)", ylab="Semivariance",
       col="black")
  title(main="Omni-Directional variogram", line=1.2)
  vl <- variogramLine(m$omni$fit, maxdist=cutoff[1])
  lines(vl$dist, vl$gamma, lwd=2, col="black")
  text(m$omni$vgm$dist, m$omni$vgm$gamma, labels=m$omni$vgm$np,
       cex=0.6, pos=3, offset=1, srt=90, xpd=TRUE)
  text(cutoff[1], 0.02, adj=1, cex=0.66, col=NULL,
       labels=bquote(~ gamma(h) == .(C__VAR[1,j]) +
                       .(C__VAR[2,j])*sph(.(C__VAR[3,j]),h) +
                       .(C__VAR[6,j])*sph(.(C__VAR[7,j]),h)))

  plot(m$major$vgm$dist, m$major$vgm$gamma, type="b", lty="dashed",
       pch=19, cex=0.7, xlim=c(0, cutoff[2]), ylim=c(0, 1.3),
       main="", frame.plot=FALSE, xlab="Distance (km)", ylab="Semivariance",
       col="black")
  title(main=sprintf("%03d Directional variogram", dir_la[i]), line=1.2)
  vl <- variogramLine(m$major$fit, maxdist=cutoff[2])
  lines(vl$dist, vl$gamma, lwd=2, col="black")
  text(m$major$vgm$dist, m$major$vgm$gamma, labels=m$omni$vgm$np,
       cex=0.6, pos=3, offset=1, srt=90, xpd=TRUE)
  text(cutoff[2], 0.02, adj=1, cex=0.66, col=NULL,
       labels=bquote(~ gamma(h) == .(C__VAR[1,j]) +
                       .(C__VAR[2,j])*sph(.(C__VAR[4,j]),h) +
                       .(C__VAR[6,j])*sph(.(C__VAR[8,j]),h)))

  plot(m$minor$vgm$dist, m$minor$vgm$gamma, type="b", lty="dashed",
       pch=19, cex=0.7, xlim=c(0, cutoff[3]), ylim=c(0, 1.3),
       main="", frame.plot=FALSE, xlab="Distance (km)", ylab="Semivariance",
       col="black")
  title(main=sprintf("%03d Directional variogram", dir_sa[i]), line=1.2)
  vl <- variogramLine(m$minor$fit, maxdist=cutoff[3])
  lines(vl$dist, vl$gamma, lwd=2, col="black")
  text(m$minor$vgm$dist, m$minor$vgm$gamma, labels=m$omni$vgm$np,
       cex=0.6, pos=3, offset=1, srt=90, xpd=TRUE)
  text(cutoff[3], 0.02, adj=1, cex=0.66, col=NULL,
       bquote(~ gamma(h) == .(C__VAR[1,j]) +
                .(C__VAR[2,j])*sph(.(C__VAR[5,j]),h) +
                .(C__VAR[6,j])*sph(.(C__VAR[9,j]),h)))

  mtext(j, side=3, line=1, outer=TRUE, font=par("font.main"), cex=par("cex.main"))
  par(o)
}
```

```{r exp-var, fig.width=8, fig.height=3.5, fig.cap="Experimental variograms."}
for (i in flds_est) {
  plot_var(i, i, cutoff=c(3,3,3))
}
```

```{r}
x <- t(C__VAR)
vario <- lapply(flds_est, function(i) {
  vgm(x[i,6], "Sph", x[i,8], anis=c(x[i,10], x[i,11]),
      add.to=vgm(x[i,2], "Sph", x[i,4], x[i,1], anis=c(x[i,10], x[i,11])))
})
names(vario) <- flds_est
rm(x)
```

---
format: html-eval-false
---

# Estimation results

The 60 m by 60 m panel estimates were added back onto the 20 m by 20 m geological domaining GIS raster model. Resource categories Measured, Indicated and Inferred Mineral Resource were added to the 20 m by 20 m raster grid model using the perimeters defined by conditional simulation.

```{r}
M__MEAN <- cache_data("./data/M/M__jura_means.rds", function() {
  x <- lapply(flds_est, function(i) {
    reclassify(M__ROCK,
               matrix(c(1,1,mean(B__AH[[i]][B__AH$rock == "SEQ"], na.rm=TRUE),
                        2,2,mean(B__AH[[i]][B__AH$rock == "KIM"], na.rm=TRUE),
                        3,3,mean(B__AH[[i]][B__AH$rock == "QUA"], na.rm=TRUE),
                        4,4,mean(B__AH[[i]][B__AH$rock == "ARG"], na.rm=TRUE),
                        5,5,mean(B__AH[[i]][B__AH$rock == "POR"], na.rm=TRUE)),
                      byrow=TRUE, ncol=3), right=NA)
  })
  x <- brick(x)
  names(x) <- flds_est

  return(x)
}, out.csv=FALSE)
```

```{r r-means, fig.width=9, fig.height=6}
par(oma=c(1,1,1,2))
plot(M__MEAN, asp=1, col=viridis(7),
     addfun=function() {
       #points(B__AH$X, B__AH$Y, pch="+");
       box(col="white")
})
```

Results of the simple kriging (SK) estimates are shown in the spatial plots (Figure \@ref(fig:r-model)).

> Describe estimation results.

```{r r-model, fig.width=9, fig.height=9, fig.cap="Simple Kriging estimates informed by PPMT data."}
par(oma=c(1,1,1,1))
x <- M__SK[[flds_est]]
plot(x, asp=1, col=inferno(20),
     addfun=function() {
       points(B__AH$X, B__AH$Y, pch="+")
       box(col="white")
       #lines(dom_meas$XP, dom_meas$YP, col="purple", lwd=2)
       #lines(dom_ind$XP, dom_ind$YP, col="blue", lwd=2)
})
```

```{r r-class, fig.width=6, fig.height=4.7, eval=FALSE}
x <- M__SK$RESCAT
x <- data.frame(rescat=values(x), coordinates(M__SK))
x$rescat <- factor(x$rescat)
levels(x$rescat) <- c("Measured", "Indicated", "Inferred")

ggplot() +
  geom_raster(data=x, aes(x=x, y=y, fill=rescat), alpha=1) +
  scale_fill_viridis(na.value="grey90", discrete=TRUE) +
  coord_equal() +
  theme(
    legend.position="top",
    axis.line = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major = element_line(color="#ebebe5", size=0.2),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    axis.text = element_text(size=8),
    plot.margin = margin(0.5, 1, 0.5, 0.5, "cm"),
    legend.key.width = unit(3, "mm"),
    legend.key.height = unit(3, "mm"),
    legend.spacing.x = unit(4, "mm"),
    legend.text = element_text(size=8),
    legend.title = element_blank()
  )
rm(x)
```

The Mineral Resource is reported in Table \@ref(tab:rep-gt0) at a nominal copper cut-off value of 0.1% Cu. Estimates were classified as either Measured, Indicated or Inferred Mineral Resource based on results of the conditional simulation of abundance.

```{r}
gt_rep0 <- cache_data("./data/M/M__jura_gt_rep0.csv", function() {
  rep_func <- function(RESCAT) {
    j <- !is.na(x$cu_pct)
    if (RESCAT>0) {
      j <- j & x$RESCAT == RESCAT
    }
    KM2.sum <- sum(KM2[j])
    MT.sum <- sum(MT[j])
    Cu_pct <- round(sum(x$cu_pct[j] * MT[j]) / MT.sum, 2)
    Co_ppm <- round(sum(x$co_ppm[j] * MT[j]) / MT.sum, 3)
    Ni_ppm <- round(sum(x$ni_ppm[j] * MT[j]) / MT.sum, 2)
    RESCAT <- switch(RESCAT+1, "All", "Measured", "Indicated", "Inferred")
    MT.sum <- round(MT.sum, 1)

    return(data.frame(RESCAT=RESCAT, MT=MT.sum,
                      Cu_pct=Cu_pct, Co_ppm=Co_ppm, Ni_ppm=Ni_ppm))
  }

  x <- as.data.frame(M__SK)
  x$density <- 1.8
  KM2 <- prod(res(M__SK))
  MT <- KM2 * x$density

  rep <- lapply(0, function(z) rep_func(z))
  rep <- do.call("rbind", rep)

  return(rep)
})
```

```{r}
gt_rep1 <- cache_data("./data/M/M__jura_gt_rep1.csv", function() {
  rep_func <- function(cutoff=4) {
    j <- !is.na(x$cu_pct) & x$cu_pct >= cutoff
    KM2.sum <- sum(KM2[j])
    MT.sum <- sum(MT[j])
    Cu_pct <- round(sum(x$cu_pct[j] * MT[j]) / MT.sum, 2)
    Co_ppm <- round(sum(x$co_ppm[j] * MT[j]) / MT.sum, 3)
    Ni_ppm <- round(sum(x$ni_ppm[j] * MT[j]) / MT.sum, 2)
    MT.sum <- round(MT.sum, 1)

    return(data.frame(Cutoff=cutoff, MT=MT.sum,
                      Cu_pct=Cu_pct, Co_ppm=Co_ppm, Ni_ppm=Ni_ppm))
  }

  x <- as.data.frame(M__SK)
  x$density <- 1.8
  KM2 <- prod(res(M__SK))
  MT <- KM2 * x$density

  minmax <- range(x$cu_pct, na.rm=TRUE)
  minmax <- floor(minmax)
  rep <- lapply(seq(minmax[1], minmax[2], by=1), function(z) rep_func(z))
  rep <- do.call("rbind", rep)

  return(rep)
})
```

```{r rep-gt0}
kable(gt_rep0, digits=1, caption="Jura Mineral Resource estimate")
```

<br>

The grade tonnage curves for Jura at various copper cutoffs are shown in Figure \@ref(fig:gt-curve).

```{r gt-curve, fig.width=5, fig.height=3.5, fig.cap="Jura grade-tonnage curve."}
par(mar=c(5,4,3,4)+0.1)

plot(gt_rep1$Cutoff, gt_rep1$MT, type="l", frame.plot=FALSE, col="blue", lwd=2,
     main="Jura Grade-Tonnage Curve", xlab="Cu (%)", ylab="",
     ylim=c(0, max(gt_rep1$MT)))
mtext("Tonnes (dry Mt)", side=2, line=3, col="blue")

par(new=TRUE)

plot(gt_rep1$Cutoff, gt_rep1$Cu_pct, xlab=NA, ylab=NA, type="l", lty="solid",
     axes=FALSE, col="red", lwd=2, ylim=c(0, max(gt_rep1$Cu_pct)))
axis(4, line=0)
mtext("Cu (%)", side=4, line=3, col="red")

abline(v=11, lty="dashed")
```

```{r}
# Export the model
x <- M__SK
x <- dropLayer(x, 1:3)
names(x) <- c("Cu","Ni","Pb","Zn","Rock")
writeRaster(x, "./data/M/M__jura_sk.nc", format="CDF", overwrite=TRUE)

x <- as.data.frame(rasterToPoints(x))
x$Rock <- (levels(M__SK$rock)[[1]]$rock)[x$Rock]
write.csv(x, "./data/M/M__jura_sk.csv", na="", row.names=FALSE)
```
